@model WebApplication1.Models.HomeViewModel
<div id="player"></div>
<script type="text/javascript" id="NeverFindThisIdAgainEver">
    $(document).ready(function () {
        $("#nextUrl").unbind();
        $('#nextUrl').on('click', NextUrlAjax);
    });

    var GlobalRowV;
    var GLobalPostData;
    var HasSynced = false;

    function SetGlobalPostData() {
        GLobalPostData = {
            rowV: GlobalRowV,
            yTime: player.getCurrentTime()
        };
    }
    function SetHasSynced(){
        HasSynced = true;
    }
    GlobalRowV = "@Model.RowVersion";
     


    /*Since this is a parialView DOMinserts. Have to "fake" youtubeApiInit When nexting.*/
    if (typeof youtube_api_init != 'undefined') {
        onYouTubeIframeAPIReady();
    }

    var player;
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '400',
            width: '640',
            videoId: '@Model.UrlCurrent',
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        event.target.playVideo();
        /*Start recursive polling after plaeyr loaded*/
        HandleAjaxResponse();
        SetGlobalPostData();
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.ENDED) {
            NextUrlAjax();
        }
        if (event.data == YT.PlayerState.PLAYING) {
            if (HasSynced) {
                setTimeB();
            }
            
        }
    }

    
    function setTimeB() {
        var timeData = {
            yTime: player.getCurrentTime()
        };
        return ajaxRequest = $.ajax({
            type: "POST",
            url: "@Url.Action("setTime", "Home")",
            data: timeData,
            dataType: "json"
        });
    }

    function NextUrlAjax(e) {
        var postData =
        {
            rowVersion: "@Model.RowVersion"
        };
        return $.ajax({
            type: "POST",
            url: "@Url.Action("NextUrl", "Home")",
            data: postData,
            dataType: "html",
            success:
            function (result) {
                $('#diviFramePart').html(result);
            }
        });
    }

</script>
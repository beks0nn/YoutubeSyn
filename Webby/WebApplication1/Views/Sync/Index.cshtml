<body>
    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-md-8" id="diviFramePart">
                <div id="player"></div>
            </div>
            <div class="col-md-4">
                <div id="divUrlList">
                    <div class="row scrollList" id="searchResults">
                        <ul class="list-group" id="urlListUL">
                            @foreach (var item in Model.UrlList)
                            {
                                <li class="list-group-item">@item.UrlPart</li>
                            }
                        </ul>

                    </div>
                </div>
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <input class="form-control"  type="text" id="url" />
                <input class="btn btn-default" type="button" id="addurl" value="Add url" />
                <input class="btn btn-default" type="button" id="nexturl" value="Next url"/>
            </div>
        </div>

        <div class="row">
        </div>
    </div>
    <hr>
</body>
@section scripts {
    <script>
        /** Init Vars from Model here ( Only from first page load).  **/
        var GlobalRowV = "@Model.RowVersion";
        var CurrentUrl = "@Model.UrlCurrent";
        var CurrentTime = "@Model.CurrentTime";

        var player;//The Youtube player 
        var syncer = $.connection.syncHub;//The WebSocket.
       

        $(function () {
            // CLIENT SIDE FUNCTIONS (USED BY HUB)
            syncer.client.addUrl = function (url) {
                // Add the url to list.
                $('#urlListUL').append('<li class="list-group-item">' + htmlEncode(url) + '</li>');
            };

            syncer.client.nextUrl = function (returnUrl) {
                player.stopVideo();
                player.loadVideoById(returnUrl);
            };

            syncer.client.goToTime = function (time, version) {
                console.log("GO TO TIME" + version);
                GlobalRowV = version;
                player.seekTo(time);
            };

            // Start the connection.
            $.connection.hub.start().done(function () {
                //Bindklick events after the Websocket is open.
                $('#addurl').click(function () {
                    syncer.server.addUrl($('#url').val());
                    $('#url').val('');
                });

                $('#nexturl').click(function () {
                    syncer.server.nextUrl();
                });
            });
        });

        /** Helper Functions **/
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

        /**** YOUTUBE FUNCTIONS ****/
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '400',
                width: '640',
                videoId: CurrentUrl,
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            event.target.playVideo();
            player.seekTo(CurrentTime);
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED) {
                syncer.server.nextUrl();
            }
            if (event.data == YT.PlayerState.PLAYING) {
                syncer.server.goToTime(player.getCurrentTime(), GlobalRowV);
            }
        }

        /*********************** Load JewTube APi ********************************/
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
</script>
}
